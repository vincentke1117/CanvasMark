# CanvasMark 产品规格说明

## 一、项目概述

- **名称**：CanvasMark
- **形态**：单页 Web 应用（可选 Electron 封装）
- **目标**：在同一编辑器内完成 Markdown 写作、插入并可反复编辑的 Drawnix 白板块，支持多套主题（编辑主题/导出主题分离），一键导出标准 HTML 与微信公众号友好 HTML。
- **范围**：前端应用与导出工具链；首发不含多人协作与云端后端。
- **非目标（首发版）**：多人实时协作、云端账户系统、在线图床、移动端适配。

---

## 二、用户画像与关键场景

- **用户类型**：内容创作者（公众号、博客）、产品/技术/设计从业者、讲师/教育者。
- **关键场景**：
  1. 在写作过程中插入一块白板，快速绘制脑图/流程图/草图，保存为文中可见的静态预览，后续可双击回到白板继续编辑。
  2. 切换排版风格以预览导出效果，确保主题与公众号兼容。
  3. 一键导出两份 HTML：用于网站/博客的标准版，以及可直接粘贴到微信公众平台的兼容版。

---

## 三、总体架构

### 前端框架与内核

- **Milkdown**：作为 Markdown 编辑与文档状态的核心（基于 ProseMirror）。
- **Drawnix/Plait**：白板内核，用作可复编辑的块级节点（NodeView）。
- **React**：视图层与 Milkdown/Drawnix 组件化整合。

### 模块划分

1. 应用壳：路由、全局状态、设置、主题管理、文件操作。
2. 编辑器内核：Milkdown 实例与 preset（CommonMark 扩展）。
3. 自定义节点层：Drawnix 块的 schema、视图、命令与事件。
4. 白板集成层：负责白板的数据导入导出（结构 JSON 与静态预览）。
5. 资源与资产管理：图片、白板预览、内联 data URI、相对路径策略。
6. 导出管线：标准 HTML 与公众号 HTML 的两条转换与清洗流程。
7. 主题系统：编辑主题与导出主题，变量与样式策略。
8. 设置与偏好：导出选项、白板默认参数、主题选择持久化。
9. 诊断与日志：导出耗时、白板渲染耗时、错误事件。

---

## 四、功能清单（详细）

### 编辑与文档

- 支持标题、段落、列表（有序/无序/任务）、引用、分割线、表格、代码块、链接、图片、脚注等。
- 支持快捷键、格式工具栏、侧边目录（可选）。

### Drawnix 块

- 在光标处插入一个块，进入白板编辑视图；保存后生成结构数据与预览图。
- 文中以静态预览显示；双击或通过工具条进入编辑模式。
- 支持删除、复制、剪切、粘贴、移动；支持调整块的显示尺寸/缩放。
- 编辑完成时进行数据校验与回写；失败则提供重试与重置为新白板的选项。

### 导出

- **标准 HTML**：从 Markdown 渲染生成，附加导出主题样式；Drawnix 块输出为图片元素并带替代文本。
- **公众号 HTML**：在标准渲染基础上执行内联样式与白名单清洗，确保可直接粘贴到微信公众平台；代码块、表格、图片尺寸与行距做兼容优化。
- **图片（长图）**：将整篇或选区渲染为单张或分段长图（PNG/JPEG），支持自定义目标宽度（如 1080/1440 px）、倍率（1x/2x/3x，用于视网膜屏与海报）、背景色/留白、页眉页脚水印与版权标注；支持“每一级标题分页/分段”。
- **PDF**：依据“打印样式/导出主题（print）”排版，支持页面尺寸（A4/Letter/自定义 mm）、方向、边距、页眉页脚（页码/标题/日期）、目录书签（按 H1–H3）、链接与参考文献跳转、图片嵌入/压缩、可选 PDF/UA 标签化与可访问文本。

### 主题

- 编辑主题用于编辑界面与内容区基础排版；导出主题用于最终 HTML；二者可独立选择与预览。
- 提供至少两套导出主题示例（经典/深色），并支持变量化扩展。

### 文件

- 新建、打开、另存为；支持项目包模式（文档、块数据、资源）。
- 自动保存（可配置，默认关闭）。

### 设置

- 导出偏好（是否内联样式/图片、代码主题、表格样式精简级别）。
- 白板偏好（默认画布尺寸、白板主题、是否显示网格）。
- 编辑偏好（是否自动列表、空格/Tab、行号）。

### 可访问性

- 完整键盘操作；语义化结构输出；图像要求 alt 描述。

---

## 五、数据模型与持久化

### 文档对象

- `id`、`title`、`content`（Markdown 文本）、`theme`（`editor`/`export` 两个字段）、`assets`（清单）、`blocks`（块映射）、`createdAt`、`updatedAt`。
- `content` 存储可包含自定义占位标记以引用块（仅存储标识与描述，不包含任何实现代码）。

### Drawnix 块对象

- `blockId`、`type`（固定为 `drawnix`）、`data`（白板结构 JSON）、`preview`（静态预览的 data URI 或相对资源路径）、`size`（宽高/缩放）、`meta`（作者、更新时间、只读标记）。

### 资产

- 图片与预览：默认以 data URI 内嵌；可选导出为相对路径资源。
- 外链图片：记录 URL；导出时可选择转为内嵌或保留外链。

### 项目包结构（建议）

- `document.md`（主内容）
- `blocks.json`（按 `blockId` 索引的对象集合）
- `assets/`（图片与预览文件）
- `meta.json`（文档元信息与导出偏好）

### 数据一致性

- 导入时校验 `content` 中的块占位与 `blocks` 映射一致；缺失则给出占位告警与修复路径。
- 删除块时同步处理 `blocks` 与孤儿资源清理。

---

## 六、自定义节点规范（Drawnix 块，无代码描述）

- **节点类型**：块级、可选择、可删除、可复制粘贴、可移动。
- **属性（attrs）**：
  - `data`：序列化的白板结构。
  - `preview`：静态预览（建议 PNG/JPEG 的 data URI）。
  - `size`：显示宽度与高度（或比例）。
  - `desc`：可选的替代文本/标题。
- **行为**：
  - 插入：在光标处创建节点，进入白板编辑视图。
  - 编辑：在节点视图内加载 `data`；编辑完成后更新 attrs 的 `data` 与 `preview`。
  - 渲染：
    - 编辑态：展示白板画布与工具条。
    - 非编辑态：展示 `preview` 静图，支持点击进入编辑。
  - 导出：输出为图片元素（使用 `preview`），并带上 `desc` 作为替代文本；如缺失 `preview`，则生成占位。
  - 错误处理：当 `data` 无法解析时，显示恢复与重置选项。

---

## 七、导出规范

### 通用规则

- 来源：以 Markdown 文本为主；遇到自定义占位进行替换策略。
- 元信息：在 HTML 中附加标题、作者、生成时间、版权。
- 图片策略：支持“全部内联”与“保留外链”；Drawnix 预览建议内联以保证可移植性。

### 标准 HTML

- 渲染：基于 CommonMark 的渲染，按导出主题包装样式。
- 自定义块：Drawnix 占位替换为图片元素，包含 alt 与尺寸；可附加 caption。
- 结构校验：确保标题层级、列表嵌套、表格语义正确输出。

### 公众号 HTML

- 样式：尽量内联；避免外链字体与复杂选择器；控制段落间距与行高。
- 白名单：移除脚本、事件属性与不被支持的标签/属性。
- 代码块：采用等宽字体与浅色背景，支持横向滚动；避免高亮依赖运行时脚本。
- 表格：精简边框与背景，避免复杂合并单元格导致兼容问题。
- 图片：最大宽度 100%，高度自适应；支持粘贴后平台的二次上传。
- 自定义块：同标准 HTML，输出图片元素；缺失时用占位并提示。

### 导出开关与参数

- 是否内联样式、是否内联图片、代码主题、表格精简级别、图片压缩等级、Math 渲染策略（内联或转图片）。
- **图片导出参数**：目标宽度（px）、倍率（1–3x）、格式（PNG/JPEG）、质量（0–100）、背景色/留白、分段策略（整篇/按标题/按分页符）、水印（文本/图片，位置/不透明度）、文件命名规则。
- **PDF 导出参数**：页面尺寸（A4/Letter/自定义）、方向（纵/横）、边距（mm）、页眉页脚（左/中/右三个占位可组合，支持页码/标题/日期/自定义文本）、目录书签（启用/禁用/层级深度）、链接样式（下划线/颜色）、图片压缩（关闭/自动/指定 DPI）、字体嵌入（CJK 首选内置字体清单）、分页控制（在 Markdown 中识别分页符占位）。

### 图片（长图）导出规范

- **输入**：整篇 Markdown 或选区；支持识别自定义分页符占位以切分多张图。
- **渲染**：以导出主题的显示样式为基准；代码块可选择“换行/滚动截断/缩小字体”策略；表格超宽时自动横向滚动或缩放。
- **输出**：PNG（无损）或 JPEG（有损），默认 1080px 宽、2x 倍率；支持合成水印、页眉页脚与页边编号。
- **兼容**：优先为公众号/长图分享适配，保证图片最大宽度 1080px 时的清晰度与文件体积平衡。

### PDF 导出规范

- **排版**：使用 print 专用样式；支持避首孤行/寡行；H1–H3 自动生成书签与 PDF 目录（Outline）。
- **资源**：图片优先内嵌；可按目标 DPI（如 144/192/300）压缩；数学公式可选择矢量（SVG→PDF 矢量）或位图嵌入。
- **可访问性**：可选输出带标签的 PDF（段落、标题、列表、表格、图片 alt 文本）；链接与注释保留。
- **分页控制**：识别 Markdown 中的分页符占位以强制换页；代码块与表格支持“禁止跨页”与“允许跨页”两种策略（溢出时自动缩放或分割）。
- **页眉页脚**：支持奇偶页差异、首页不同、显示文档标题/作者/日期/页码样式（1/1 of N）。

---

## 八、分页与分段标记规范

### 目的

为导出 **PDF** 与 **图片（长图）** 提供确定性的分页/分段控制，同时在 **标准 HTML/公众号 HTML** 中不产生可见残留。

### 标记类型与书写

- **硬性分页**：写入一个专用占位令牌（命名为 `page-break`，需独占一行）。
- **分段切图**：写入一个专用占位令牌（命名为 `section-break`，需独占一行）。
- **禁止分页包裹**：使用一对起止占位令牌（命名为 `no-break-start` 与 `no-break-end`），将中间内容视为不可被分页/切图拆分的整体。
- **伴随约束**：在段落或标题之前插入 `keep-with-next`，表示本段与后一个块必须同页/同图；相反规则为 `keep-with-previous`。
- **位置偏好**：在下一块前插入 `page-top`，表示“尽量置顶显示”；可选 `page-bottom` 表示“尽量置底显示”。
- **条件分页**：在分页令牌后附带条件标签（例如 `odd` 或 `even`），表示在奇/偶页强制对齐后再换页；若不满足则自动插入空白页以满足条件。

> 说明：以上名称为**保留关键字**，必须位于单独一行且不与正文混排。为避免与正文冲突，编辑器提供“插入标记”的菜单项与快捷键，用户无需手写。

### 作用与优先级

1. 显式标记（`page-break`/`section-break`/`no-break`/`keep-with-…`）优先于全局导出策略。
2. 冲突规则：
   - `page-break` 与 `no-break` 冲突时，若同一位置出现两者，以 **`page-break` 为准**；
   - `keep-with` 系列与 `page-top`/`page-bottom` 冲突时，以 **`keep-with` 为准**；
   - 多个连续 `page-break` 视为一次分页。
3. 保护失败回退：若 `no-break` 包裹内容超出一页/单图最大高度，采用“就近安全点分割 + 重复标题”回退策略，并在导出日志提示。

### 各导出目标的解释

- **标准 HTML**：所有标记在渲染前被移除；不产生可见节点与占位。
- **公众号 HTML**：同标准 HTML；仅影响渲染前的结构整形与资源内联策略。
- **图片（长图）**：
  - `page-break`：在此处 **切分为新图片**；
  - `section-break`：在此处 **优先切分**；若与全局“按标题分段”并存，显式标记优先；
  - `no-break`：保证包裹内容在同一张图片内；若难以满足触发“保护失败回退”；
  - `keep-with`：确保两个相邻块不被分到不同图片；
  - `page-top`/`page-bottom`：作为布局偏好，若无法满足可忽略且记录为软警告。
- **PDF**：
  - `page-break`：立即 **换到新页**；支持 odd/even 对齐；
  - `section-break`：默认等同于 `page-break`（可在设置中改为“仅影响长图，不影响 PDF”）；
  - `no-break`：禁止在包裹内容内分页；
  - `keep-with`：合并相邻块进入同一页；
  - `page-top`/`page-bottom`：作为分页器的软约束；无法满足时可被忽略且记录软警告。

### 校验与提示

- 令牌必须独占一行；若与文本同行，提示“无效标记”。
- `no-break-start`/`no-break-end` 必须成对出现且允许嵌套深度 ≤ 2；不匹配时导出失败并给出修复建议。
- 连续的 `page-break` 自动合并；多余的空段清理。
- 大块保护失败（内容超页/超图）：导出继续，应用回退策略并在报告中列出位置与原因。
- 与标题大纲冲突（例如在 H1 前插入 `keep-with-previous` 但前块不存在）：提示并忽略该标记。

### 自动规则（无显式标记时的默认行为）

- 避免孤行/寡行：标题至少与其后 2 行正文同页；段落最后 2 行不单独出现在新页。
- 列表与代码块：默认不在中间分页，除非长度超过页面高度的 80%，此时在安全断点（列表项边界、代码行）分页。
- 长图默认按二级标题（H2）作为切图点；可在设置中切换为 H1/H3 或关闭。

### UI 呈现与交互

- 编辑器中以**不可打印符号**显示：
  - `page-break`：横向虚线并标注“分页”；
  - `section-break`：短虚线并标注“分段”；
  - `no-break`：以淡色括注标记包裹范围的起止；
  - `keep-with` 与 `top/bottom`：在相应块左侧显示小徽标与悬浮说明。
- 提供“显示/隐藏不可见标记”的开关。
- 工具栏提供插入/删除上述标记的命令；支持撤销/重做。

### 兼容与映射

- 导入时将常见约定映射为本规范：如传统的“分页注释”或换页符（表单馈送）。
- 若检测到与第三方方言冲突的标记，保留原文并提示用户选择映射策略。

---

## 九、主题系统规范

- **主题类型**：编辑主题（影响编辑 UI 与内容区）与导出主题（影响最终 HTML）。
- **主题结构**：变量（颜色、字体、字号、行高、间距、边框、阴影）、组件样式（标题、段落、列表、表格、引用、代码块、图片与说明）。
- **交互**：主题选择面板；编辑主题与导出主题可独立选择；导出前可预览。

### 示例主题要求

- **经典风**：衬线标题/无衬线正文字体、适中行距、明显层级感的 H1-H3、浅灰表格边框、淡色代码背景。
- **深色风**：深背景、亮文字、对比度合规、代码块高亮色彩适中、链接与强调色可达 AA 对比度。

---

## 十、UI/UX 规格

- **导航与布局**：顶部工具栏（文件、编辑、插入、主题、导出、帮助）；主区为编辑画布；右侧为属性/预览抽屉。
- **关键交互**：
  - 插入 Drawnix 块：通过“插入”菜单或快捷键；进入编辑视图；保存或取消。
  - 白板编辑：提供常见图元、对齐/分布、撤销/重做、主题切换、画布缩放；保存生成预览并返回文档。
  - 主题切换：即时作用于编辑区；导出主题切换提供预览面板。
  - 导出：弹出参数面板；确认后生成两个 HTML 文件或其一；显示耗时与体积。
- **辅助能力**：
  - 侧边目录（可选）、大纲跳转。
  - 图片/资源管理器（可选）。
  - 状态栏显示字数、段落数、块数量与上次保存时间。
- **可访问性**：所有操作可用键盘完成；聚焦可见；对比度满足 WCAG AA；为图片与 Drawnix 预览提供替代文本字段。

---

## 十一、性能与指标

- **性能预算**：
  - 首屏可交互：不超过 2.0 秒（本地热缓存）。
  - 输入延迟：50 分位不超过 16 ms。
  - 插入/打开 100–300 节点的白板：首帧渲染不超过 200 ms。
  - 导出标准 HTML：不超过 500 ms；导出公众号 HTML：不超过 800 ms。
  - 导出图片（长图）：不超过 1.2 s（1080px 宽、≤ 5 张）。
  - 导出 PDF：不超过 1.5 s（A4、10 页以内，含中等数量图片与 1 个 Drawnix 预览）。
- **优化策略**：懒加载白板内核与导出管线、长文滚动虚拟化、图片延迟解码、工作线程进行内联与清洗处理、主题样式按需装载。

---

## 十二、错误处理与可恢复性

- **错误类型**：白板数据损坏、资源缺失、导出失败、主题加载失败、粘贴不兼容。
- **处理策略**：
  - 提示并提供恢复按钮；保留上一个可用版本的预览；允许导出时以占位图片替代。
  - 导出失败时给出失败原因、可能的解决方案与重试入口。
  - 记录可匿名的本地诊断日志（默认仅本地保存，不上报）。

---

## 十三、设置、偏好与本地化

- **设置项**：编辑、白板、导出、主题、快捷键。
- **持久化**：浏览器本地存储与项目包。
- **本地化**：中文、英文两种语言；日期与数字遵循浏览器区域设置。

---

## 十四、安全与隐私

- 默认离线工作，不向外发送文档/图片/白板数据。
- 导出 HTML 移除脚本与事件属性，避免执行型内容。
- 若引入在线字体或主题 CDN，需提供离线等价方案与开关。

---

## 十五、第三方依赖与许可（方向性要求）

- **编辑与渲染**：Milkdown、CommonMark 渲染工具链。
- **白板**：Drawnix/Plait 及相关基础库。
- **导出与清洗**：用于生成标准 HTML 与公众号 HTML 的转换与清洗工具链（需选择支持白名单、内联样式与图片压缩的方案）。
- **主题**：自研为主；如使用第三方主题，需明确其许可证并在文档中披露。
- **许可建议**：整体仓库采用宽松许可证（如 MIT/Apache-2.0），第三方主题若为 GPL 类需隔离为可选资源并清晰标注。

---

## 十六、CI/CD 与质量

- 持续集成：安装依赖、风格检查、类型检查、单元测试、构建。
- 预览：构建演示站用于审阅（可选）。
- 版本发布：采用语义化版本与变更日志；多包时建议集中管理版本与发布。

---

## 十七、测试计划与验收标准

- **测试维度**：
  - 单元：Markdown 元素解析/互转、块节点的属性读写、导出参数处理。
  - 集成：插入/编辑/保存/再次编辑 Drawnix 块；导出两类 HTML 并进行快照比对。
  - 端到端：关键用户路径（插入白板→写作→切主题→导出→在公众号粘贴预览）。
  - 性能：基准文档与白板的导出与渲染时延。
  - 兼容：Chrome/Edge/Firefox/Safari 最新稳定版本。
- **验收用例（示例）**：
  - 当用户插入 Drawnix 块并编辑后保存时，文档中出现静态预览，重新打开仍可进入编辑且图形完整。
  - 当用户将“公众号 HTML”粘贴到微信公众平台编辑器时，标题、段落、代码块、表格与图片样式与预期一致，无样式丢失或错位。
  - 在切换导出主题后再次导出，结构一致且样式符合新主题定义。

---

## 十八、发布计划与里程碑（建议）

- **M1（第 2 周）**：基础编辑、文件操作、编辑主题与导出主题框架。
- **M2（第 4 周）**：Drawnix 块可插入/编辑/预览/持久化；基本资源管理。
- **M3（第 6 周）**：标准 HTML 导出稳定；公众号 HTML 导出 Beta；主题示例完善。
- **M4（第 8 周）**：性能优化、A11y、跨浏览器验证；试用反馈修整。
- **GA（第 9–10 周）**：正式发布与文档完善。

---

## 十九、风险与缓解

- 公众号粘贴器策略变化：保留粘贴自检流程与快速修复清单。
- 白板性能瓶颈：支持延迟生成预览、可配置图片压缩与分辨率；对超大白板提供“仅导出图片的轻量模式”。
- 第三方主题授权不兼容：默认内置自研主题并隔离外部主题资源。
- 用户误删块数据：提供项目包级回收/还原机制与导入时校验报告。

---

## 二十、术语表

- **Milkdown**：基于 ProseMirror 的可扩展 Markdown 编辑框架。
- **Drawnix/Plait**：基于 Plait 的白板/脑图/流程图内核。
- **NodeView**：在编辑器中自定义节点的可视化渲染与交互视图。
- **标准 HTML**：用于网站/博客的通用 HTML 输出。
- **公众号 HTML**：针对微信公众平台编辑器约束进行适配、内联与清洗的 HTML 输出。

---

## 二十一、增强建议（已纳入路线图）

### 20.1 可扩展与长期演进

- 插件/扩展点：菜单、侧栏面板、导出前/后处理器、渲染钩子、块级节点注册；版本化与弃用策略。
- 文档与块数据的 `schemaVersion` 与迁移规则；提供迁移报告与“安全回退”。
- 主题令牌化：颜色、字号、间距、边框、阴影、语法色板等设计令牌；主题编辑器（后续版本）。
- 模板中心：文章模板、公众号版式模板、导出预设，支持团队共享。

### 20.2 写作质量与内容生态

- 内容体检（Lint）：标题层级、重复标题、图片 alt 缺失、超宽表格、坏链等；导出前阻断/警告策略。
- 引用/参考文献：脚注基础，扩展 CSL 以生成人类可读引用与参考文献区。
- 数学/图表：KaTeX/MathJax 导出策略（矢量/位图）；Mermaid/PlantUML 的 SVG→PNG 兜底。
- CJK 排版优化：标点禁则、挤压、自动空隙；字体回退清单。

### 20.3 资源与发布

- 图片优化：长边限制、质量曲线、WebP/PNG/JPEG 选择、去 EXIF、去透明与底色策略。
- SVG 兜底：不稳定目标平台时自动转 PNG；标准 HTML 保留 SVG。
- 一键复制公众号片段；稳定锚点/目录；PDF 书签与大纲同步。

### 20.4 性能与稳健

- 大文档基准集；白板/导出性能基线；懒加载；导出在 Worker 中执行（沙箱）。
- 失败与软警告枚举：图片过宽、`no-break` 失败、公式超限、表格跨页等，带编号与建议。

### 20.5 存储与协作

- 自动保存与快照时间轴；多窗口冲突检测与合并指导；预留 Yjs/CRDT 接入点。

### 20.6 可访问性与合规

- A11y 清单（AA 对比度、键盘可达、焦点可见、图片替代文本校验）。
- PDF/UA（可选）；CSP 建议；第三方主题/字体 License 审计。

### 20.7 生态互通

- 导入适配：Obsidian/Typora 方言、Front Matter、常见分页注释映射。
- 白板互操作：draw.io/Excalidraw/SVG 的基础导入（图元与文本）。
- 发布：标准 HTML 兼容静态站；打包 ZIP 便利交付。

### 20.8 产品化与交付

- 新手引导与示例内容；多端预览（桌面/移动、公众号模拟）；诊断面板；质量闸门（导出前体检）。

### 20.9 运维与 CI

- 黄金样本对比（结构/像素回归）；浏览器矩阵 E2E；错误采样（默认本地）。

---

## 二十二、第三方仓库与主题参考

- **Milkdown 仓库**：<https://github.com/Milkdown/milkdown>
- **Drawnix 仓库**：<https://github.com/plait-board/drawnix>
- **Typora 主题参考**：
  - Orange Heart：<https://github.com/evgo2017/typora-theme-orange-heart>
  - Purple Theme：<https://github.com/hliu202/typora-purple-theme>

> 说明：若引入第三方主题，请在许可证与依赖合规章节登记其许可与使用范围；必要时将外部主题隔离为可选资源包。

---

## 二十三、实现路线（从小到大）

以“最小可用 → 体验完善 → 生态拓展”的顺序迭代，分阶段可独立交付。

### 阶段 0：项目骨架与基础工程（第 1 周）

- **目标**：可安装、可运行、可构建，确保工程可持续迭代。
- **范围**：工作区与包结构、类型检查、风格规范、CI 基线、演示站。
- **验收**：在目标浏览器打开 Demo，空白文档可保存/打开，CI 通过。

### 阶段 1：Markdown 基础编辑（第 2–3 周）

- **目标**：完成 Milkdown 基本编辑体验与主题框架。
- **范围**：标题/段落/列表/表格/代码/图片；编辑主题与导出主题的分离与切换；文件新建/打开/另存。
- **验收**：用 Demo 文档验证渲染一致性；切换编辑/导出主题时预览更新；体检提示图片缺 alt。

### 阶段 2：Drawnix 块（第 3–5 周）

- **目标**：在文档中插入可复编辑的白板块。
- **范围**：自定义节点（schema/视图/命令）、白板数据的读写、预览生成与持久化、删除/复制/移动、错误回退。
- **验收**：插入→绘制→保存→生成预览→关闭→再次打开可继续编辑且数据一致。

### 阶段 3：导出标准 HTML（第 5–6 周）

- **目标**：一键生成可用的标准 HTML。
- **范围**：Markdown 渲染、主题包装、资源策略（图片内联/外链）、Drawnix 占位替换为图片、元信息注入。
- **验收**：导出文件在本地浏览器打开一致显示；体积与资源路径符合设置；含 Drawnix 预览。

### 阶段 4：公众号 HTML（第 6–7 周）

- **目标**：可直接粘贴到微信公众平台且样式稳定。
- **范围**：内联样式、白名单清洗、代码/表格兼容、图片宽度控制、复制到剪贴板。
- **验收**：在平台粘贴预览不走样；代码块可横向滚动；表格边框/斑马纹符合预期。

### 阶段 5：图片（长图）与 PDF 导出（第 7–8 周）

- **目标**：导出整篇或分段长图与可打印 PDF。
- **范围**：分页与分段标记实现、图片导出参数与水印、PDF 页面设置/目录书签/可选 PDF/UA、失败与软警告报告。
- **验收**：示例文档按 H2 自动切图；插入 `page-break` 生效；PDF 含书签且分页正确。

### 阶段 6：主题与模板生态（第 8–9 周）

- **目标**：可快速套用与扩展主题/模板。
- **范围**：导出主题变量化；示例主题完善（经典/深色）；引入 Typora 主题参考的映射与限制说明；模板中心雏形。
- **验收**：选择不同主题导出的 HTML/PDF/长图风格一致；可基于变量快速定制一套新主题。

### 阶段 7：质量、性能与可访问性（第 9–10 周）

- **目标**：达到发布质量门槛。
- **范围**：性能优化、A11y 清单达标、黄金样本回归、浏览器矩阵 E2E、诊断面板与导出报告。
- **验收**：性能预算满足；AA 对比度通过；回归无差异；导出报告列出软警告与耗时。

### 阶段 8：可选增强与生态扩展（持续）

- **方向**：
  - Worker 化导出、CRDT 协作预留、数学/图表生态、图片优化管线、白板互操作（draw.io/Excalidraw）、静态站发布适配等。

---

## 二十四、里程碑清单（汇总视图）

- M0：工程骨架上线（阶段 0）。
- M1：基础编辑可用（阶段 1）。
- M2：Drawnix 块可插入/编辑（阶段 2）。
- M3：标准 HTML 导出（阶段 3）。
- M4：公众号 HTML 导出（阶段 4）。
- M5：长图 & PDF 导出（阶段 5）。
- M6：主题/模板生态（阶段 6）。
- M7：质量与发布（阶段 7）。

---

## 二十五、验收与度量

### 功能验收（摘录）

- 插入 Drawnix 块后，导出标准/公众号 HTML 与 PDF/长图均能正确替换为图片且具备可读 alt。
- 分页/分段令牌的冲突与回退按照规范执行，并在报告中记录。

### 体验与性能度量

- 输入延迟（50p）≤ 16 ms；标准 HTML ≤ 500 ms；公众号 HTML ≤ 800 ms；长图 ≤ 1.2 s（≤ 5 张，1080px 宽）；PDF ≤ 1.5 s（10 页以内）。
- 体检通过率 ≥ 95%（示例集）；软警告均给出定位与建议。

---

## 二十六、合规与许可证更新

- 对引入的第三方主题与字体在“依赖与许可”章节记录来源与许可证；
- Typora 主题参考仅作为外观灵感或导出主题的映射示例，实际集成前需确认其许可证是否与项目许可兼容；
- 默认内置自研可商用主题，第三方主题以可选资源包形式隔离。
